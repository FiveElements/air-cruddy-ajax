<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<script>

    /**
     * FiveElements Namespace definition
     */
    var FiveElements = FiveElements || {};

    /**
     * @polymerBehavior
     *
     * Crud Accessor that convert every Server to the expected format
     *
     *
     * The Apis To Implement
     *
     * ### Get Response Format
     *
     *    {
     *       _id: "AAApkZAAOAAAQYEAAJ",
     *       _version: 1,
     *       _source: {
     *         firstname: "Leeloomina誰",
     *         lastname: "Lekatariba Lamina-Tcha誰 Ekbat De Sebat"
     *       }
     *    }
     *
     * ### Save (Create / Update) Response Format
     *
     *    {
     *       version: 1,
     *       body: {
     *         firstname: "Leeloomina誰",
     *         lastname: "Lekatariba Lamina-Tcha誰 Ekbat De Sebat"
     *       }
     *    }
     */
    FiveElements.AirCruddyCloudyBehavior = {
        properties: {
            endpoint: {
                type: String,
                notify: true
            },
            headers: {
                type: Object,
                value: function() {
                    return {};
                }
            }
        },
        // --- Life Cycle
        // --- ---------------------------

        created: function () {
            // Object that handles the ajax form submission request.
            this._requestGet = this._createGetIronAjax();
            this._requestCreate = this._createCreateIronAjax();
            this._requestUpdate = this._createUpdateIronAjax();
            this._requestDelete = this._createDeleteIronAjax();
            // Log
            // console.log('End Ready behaviors', 'endpoint', this.endpoint);
        },


        // --- Service Instantiation
        // --- ---------------------------
        _createIronAjax: function (type, verb) {
            var requestBot = document.createElement('iron-ajax');
            requestBot.method = verb || type.toUpperCase();
            requestBot.contentType = 'application/json';

            requestBot.addEventListener('response', this['_handleResponse' + type].bind(this));
            requestBot.addEventListener('error', this['_handleError' + type].bind(this));
            return requestBot;
        },

        _createGetIronAjax: function () {
            return this._createIronAjax('Get');
        },
        _createCreateIronAjax: function () {
            return this._createIronAjax('Create', 'POST');
        },
        _createUpdateIronAjax: function () {
            return this._createIronAjax('Update', 'PUT');
        },
        _createDeleteIronAjax: function () {
            return this._createIronAjax('Delete');
        },


        // --- Required Api
        // --- ---------------------------
        _entityGetBaseUrl: function (opt) {
            var endpointUrl = this.endpoint;
            return endpointUrl;
        },

        _entityGetUrl: function (opt, ver) {
            var entityId, version;
            if (typeof opt === 'string') {
                entityId = opt;
                version = ver;
            } else { // Opt is JSON
                entityId = opt._id || opt.id;
                version = opt._version || opt.version;
            }
            var endpointUrl = this._entityGetBaseUrl(opt);
            if (entityId) {
                endpointUrl += '/' + entityId;
            }
            if (version) {
                endpointUrl += '?version=' + version;
            }
            // console.log('Ajax get Url', endpointUrl);
            return endpointUrl;
        },

        _entityUrlCreate: function (entityId) {
            return this.endpoint;
        },
        _entityUrlUpdate: function (entityId, entityVersion) {
            return this._entityGetUrl(entityId, entityVersion);
        },
        _entityUrlDelete: function (entityId, entityVersion) {
            return this._entityGetUrl(entityId, entityVersion);
        },

        _serializeDataCreate: function (data) {
            console.error('Required Api implementation for function : [%s]', '_serializeDataCreate');
        },

        _serializeDataUpdate: function (data) {
            console.error('Required Api implementation for function : [%s]', '_serializeDataUpdate');
        },
        _serializeDataDelete: function (data) {
            console.error('Required Api implementation for function : [%s]', '_serializeDataDelete');
        },

        _deserializeDataGet: function (data) {
            return data;
        },

        _serializeDataAsString: function(data) {
            return JSON.stringify(data);
        },

        // --- TODO Delete The Apis Belows
        // --- ------------------------------------

        _extractResponseVersion: function (data) {
            if (data && data._version) {
                return data._version;
            }
            return undefined;
        },
        _extractResponseId: function (data) {
            if (data && data._id) {
                return data._id;
            }
            return undefined;
        },


        // --- Common Format response converter
        // --- ------------------------------------
        _convertAjaxContentAsJson: function (detail) {
            return detail;
        },

        _convertAjaxError: function (event) {
//            console.error('Error : ', event.detail);
//            console.error('Error request : ', event.detail.request.xhr);
            var error = this._convertAjaxContentAsJson(event.detail.error);
            // Status
            var xhrRes = event.detail.request.xhr;
            var status = xhrRes.status;
            var statusText = xhrRes.statusText;
            var detail = {
                error: error,
                status: status,
                statusText: statusText
            };
            this.fire('air-cruddy-error', detail);
            return detail;
        },

        _convertAjaxResponse: function (event) {
            var response = this._convertAjaxContentAsJson(event.detail.response);
            // Status
            var xhrRes = event.detail.xhr;
            var status = xhrRes.status;
            var statusText = xhrRes.statusText;
            var detail = {
                response: response,
                status: status,
                statusText: statusText
            };
            this.fire('air-cruddy-response', detail);
            return detail;
        },

        _convertAjaxResponseGet: function (event) {
            var detail = this._convertAjaxResponse(event);
            // Convert Data Format to a common format
            var data = this._deserializeDataGet(detail.response);
            detail.response = data;
            return detail;
        },

        // --- Entity Save handler
        // --- ---------------------
        _convertAjaxResponseSave: function (event) {
            var detail = this._convertAjaxResponse(event);
            // Fire Event
            this.fire('air-cruddy-response-save', detail);
            return detail;
        },

        _convertAjaxErrorSave: function (event) {
            var detail = this._convertAjaxError(event);
            this.fire('air-cruddy-error-save', detail);
            return detail;
        },

        // --- Entity GET
        // --- ---------------------------

        _definedRequestBotParams: function (requestBot) {
            requestBot.headers = this.headers;
        },
        /**
         * Called to request the get the entity from server.
         */
        _entityGet: function (entityId, entityVersion) {
            console.log('Ajax arguments : ', arguments);
            this._requestGet.url = this._entityGetUrl(entityId, entityVersion);
            console.log('Request Entity Get for Url : ', this._requestGet.url);
            this._definedRequestBotParams(this._requestGet);
            this._requestGet.generateRequest();
        },

        _handleResponseGet: function (event) {
            //console.error('Required Api implementation for function : [%s]', '_handleResponseGet');
            var detail = this._convertAjaxResponseGet(event);
            // Fire Event
            this._onResponseGet(detail);
            this.fire('air-cruddy-response-get', detail);
        },
        _handleErrorGet: function (event) {
            // console.error('Required Api implementation for function : [%s]', '_handleErrorGet');
            var detail = this._convertAjaxError(event);
            this._onErrorGet(detail);
            // Fire Event
            this.fire('air-cruddy-error-get', detail);
        },

        _onResponseGet: function (detail) {
        },
        _onErrorGet: function (detail) {
        },
        // --- Entity Create
        // --- ---------------------
        /**
         * Called to request the create the entity to server.
         */
        _entityCreate: function (entityId, data, entityVersion) {
            this._definedRequestBotParams(this._requestCreate);

            this._requestCreate.url = this._entityUrlCreate(entityId, entityVersion);
            this._requestCreate.body = this._serializeDataCreate(data);
            this._requestCreate.generateRequest();
        },

        _handleResponseCreate: function (event) {
            //console.error('Required Api implementation for function : [%s]', '_handleResponseCreate');
            var detail = this._convertAjaxResponseSave(event);
            this._onResponseCreate(detail);
            // Fire Event
            this.fire('air-cruddy-response-create', detail);
        },

        _handleErrorCreate: function (event) {
            // console.error('Required Api implementation for function : [%s]', '_handleErrorCreate');
            var detail = this._convertAjaxErrorSave(event);
            this._onErrorCreate(detail);
            // Fire Event
            this.fire('air-cruddy-error-create', detail);
        },
        _onResponseCreate: function (detail) {
        },
        _onErrorCreate: function (detail) {
        },

        // --- Entity Update
        // --- ---------------------
        /**
         * Called to request the update the entity to server.
         */
        _entityUpdate: function (entityId, data, entityVersion) {
            this._definedRequestBotParams(this._requestUpdate);

            this._requestUpdate.url = this._entityUrlUpdate(entityId, entityVersion);
            console.log('Request Entity Update for Url : ', this._requestUpdate.url, ' / data ', data);
            this._requestUpdate.body = this._serializeDataUpdate(data);
            this._requestUpdate.generateRequest();
        },

        _handleResponseUpdate: function (event) {
            var detail = this._convertAjaxResponseSave(event);
            this._onResponseUpdate(detail);
            // Fire Event
            this.fire('air-cruddy-response-update', detail);
        },
        _handleErrorUpdate: function (event) {
            var detail = this._convertAjaxErrorSave(event);
            this._onErrorUpdate(detail);
            // Fire Event
            this.fire('air-cruddy-error-update', detail);
        },

        _onResponseUpdate: function (detail) {
            //console.error('Required Api implementation for function : [%s]', '_onResponseUpdate');
        },
        _onErrorUpdate: function (detail) {
            //console.error('Required Api implementation for function : [%s]', '_onErrorUpdate');
        },


        // --- Entity Delete Create
        // --- ---------------------
        /**
         * Called to request the delete the entity to server.
         */
        _entityDelete: function (entityId, entityVersion) {
            this._definedRequestBotParams(this._requestDelete);

            this._requestDelete.url = this._entityUrlDelete(entityId, entityVersion);
            this._requestDelete.body = this._serializeDataDelete(data);
            this._requestDelete.generateRequest();
        },

        _handleResponseDelete: function (event) {
            //console.error('Required Api implementation for function : [%s]', '_handleResponseDelete');
            var detail = this._convertAjaxResponse(event);
            this._onResponseDelete(detail);
            this.fire('air-cruddy-response-delete', detail);
        },

        _handleErrorDelete: function (event) {
            //console.error('Required Api implementation for function : [%s]', '_handleErrorDelete');
            var detail = this._convertAjaxError(event);
            this._onErrorDelete(detail);
            this.fire('air-cruddy-error-delete', detail);
        },


        _onResponseDelete: function (detail) {
        },

        _onErrorDelete: function (detail) {
        },


        // --- Other
        // --- ---------------------


    };


    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyCloudyDefaultApiBehavior = {

        // --- Entity Serialization Apis
        // --- ---------------------------
        _serializeDataCreate: function (data) {
            var opt = {
                body: data._source
            };
            return  this._serializeDataAsString(opt);
        },

        _serializeDataUpdate: function (data) {
            var opt = {
                version: data._version,
                body: data._source
            };
            return this._serializeDataAsString(opt);
        },
        _serializeDataDelete: function (data) {
            var opt = {
                version: data._version
            };
            return this._serializeDataAsString(opt);
        }
    };

    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyCloudyDefaultImplBehavior = [FiveElements.AirCruddyCloudyBehavior, FiveElements.AirCruddyCloudyDefaultApiBehavior];


</script>
